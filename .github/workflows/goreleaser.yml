name: goreleaser

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  alpha:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
      artifact-metadata: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
        with:
          fetch-depth: 0
      - name: Compute alpha version
        id: alpha
        shell: bash
        run: |
          set -euo pipefail
          last_tag=$(
            {
              git tag -l 'v[0-9]*.[0-9]*.[0-9]*' \
                | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
                | sort -V \
                | tail -n1
            } || true
          )
          if [ -z "$last_tag" ]; then
            base_version="v0.1.0"
          else
            IFS='.' read -r major minor patch <<<"${last_tag#v}"
            next_minor=$((minor + 1))
            base_version="v${major}.${next_minor}.0"
          fi
          last_alpha=$(git tag -l "${base_version}-alpha.*" --sort=-v:refname | head -n1)
          if [ -z "$last_alpha" ]; then
            alpha_num=1
          else
            alpha_num="${last_alpha##*.}"
            alpha_num=$((alpha_num + 1))
          fi
          alpha_version="${base_version}-alpha.${alpha_num}"
          echo "version=${alpha_version}" >> "$GITHUB_OUTPUT"
          echo "ALPHA_VERSION=${alpha_version}" >> "$GITHUB_ENV"
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: go.mod
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0
      - name: GoReleaser (snapshot)
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser-pro
          args: release --snapshot --clean
        env:
          GORELEASER_KEY: ${{ secrets.GORELEASER_PRO }}
      - uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3
        with:
          subject-checksums: dist/checksums.txt
      - name: Create alpha GitHub release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ steps.alpha.outputs.version }}
          name: ${{ steps.alpha.outputs.version }}
          prerelease: true
          target_commitish: ${{ github.sha }}
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/*.sbom*
            dist/checksums.txt
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: workset-alpha-${{ github.sha }}
          path: dist/*

  release:
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-alpha.')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
      artifact-metadata: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GORELEASER_GH_TOKEN: ${{ secrets.GORELEASER_GH_TOKEN }}
      MACOS_SIGN_P12: ${{ secrets.MACOS_SIGN_P12 }}
      MACOS_SIGN_PASSWORD: ${{ secrets.MACOS_SIGN_PASSWORD }}
      MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}
      MACOS_NOTARY_KEY_ID: ${{ secrets.MACOS_NOTARY_KEY_ID }}
      MACOS_NOTARY_ISSUER_ID: ${{ secrets.MACOS_NOTARY_ISSUER_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: go.mod
      - name: Set up Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"
      - name: Ensure npm supports trusted publishing
        shell: bash
        run: |
          set -euo pipefail
          npm install -g npm@11.5.1
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0
      - name: Notarization status
        shell: bash
        run: |
          set -euo pipefail
          missing=()
          for var in MACOS_SIGN_P12 MACOS_SIGN_PASSWORD MACOS_NOTARY_KEY MACOS_NOTARY_KEY_ID MACOS_NOTARY_ISSUER_ID; do
            if [ -z "${!var:-}" ]; then
              missing+=("$var")
            fi
          done
          if [ ${#missing[@]} -eq 0 ]; then
            echo "::notice::macOS notarization enabled (all required env vars present)."
          else
            echo "::notice::macOS notarization skipped; missing: ${missing[*]}"
          fi
      - name: GoReleaser (release)
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser-pro
          args: release --clean
        env:
          GORELEASER_KEY: ${{ secrets.GORELEASER_PRO }}
      - uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3
        with:
          subject-checksums: dist/checksums.txt
