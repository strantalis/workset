version: "3"

includes:
  common: ../Taskfile.yml

tasks:
  build:
    summary: Builds the application natively on macOS
    cmds:
      - task: common:generate:icons
      - task common:build:frontend
      - go build -o {{.BIN_DIR}}/{{.APP_NAME}}
    env:
      GOOS: darwin
      CGO_ENABLED: 1
      GOARCH: "{{.ARCH | default ARCH}}"

  package:
    summary: Packages the application into a `.app` bundle
    deps:
      - task: build
    cmds:
      - task: create:app:bundle

  build:dev:
    summary: Builds the development binary on macOS
    cmds:
      - task: common:generate:icons
      - task common:build:frontend:dev
      - go build -tags dev -o {{.BIN_DIR}}/{{.APP_NAME}}
    env:
      GOOS: darwin
      CGO_ENABLED: 1
      GOARCH: "{{.ARCH | default ARCH}}"

  create:app:bundle:
    summary: Creates a `.app` bundle
    cmds:
      - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS"
      - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources"
      - cp build/darwin/icons.icns "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources"
      - |
        if [ -f build/darwin/Assets.car ]; then
          cp build/darwin/Assets.car "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources"
        fi
      - cp "{{.BIN_DIR}}/{{.APP_NAME}}" "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS"
      - cp "build/darwin/Info.plist" "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Info.plist"
      - task: '{{if eq OS "darwin"}}codesign:adhoc{{else}}codesign:skip{{end}}'

  codesign:adhoc:
    summary: Ad-hoc signs the app bundle (macOS only)
    internal: true
    cmds:
      - codesign --force --deep --sign - "{{.BIN_DIR}}/{{.APP_NAME}}.app"

  codesign:skip:
    summary: Skips codesigning when cross-compiling
    internal: true
    cmds:
      - 'echo "Skipping codesign (not available on {{OS}}). Sign the .app on macOS before distribution."'

  run:
    summary: Runs the built desktop binary
    cmds:
      - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/MacOS"
      - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/Resources"
      - cp build/darwin/icons.icns "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/Resources"
      - |
        if [ -f build/darwin/Assets.car ]; then
          cp build/darwin/Assets.car "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/Resources"
        fi
      - cp "{{.BIN_DIR}}/{{.APP_NAME}}" "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/MacOS"
      - cp "build/darwin/Info.dev.plist" "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/Info.plist"
      - codesign --force --deep --sign - "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app"
      - "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/MacOS/{{.APP_NAME}}"
